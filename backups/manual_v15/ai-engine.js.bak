// ========================================
// OmniBet AI - AI Prediction Engine (BACKUP V15)
// ========================================

import { calculateGoalExpectancy, calculatePoissonProbabilities } from './advanced-math';

/**
 * AI Engine for sports predictions
 * Simulates advanced ML models with statistical analysis
 */

// Factor weights for each sport
const SPORT_FACTORS = {
    football: {
        homeAdvantage: 0.15,
        recentForm: 0.25,
        headToHead: 0.15,
        xgDifferential: 0.20,
        squadStrength: 0.15,
        fatigue: 0.10,
    },
    basketball: {
        pace: 0.15,
        offensiveEfficiency: 0.25,
        defensiveRating: 0.20,
        backToBack: 0.15,
        homeAdvantage: 0.10,
        starPlayerImpact: 0.15,
    },
    baseball: {
        pitcherMatchup: 0.30,
        bullpenStrength: 0.15,
        battingAverage: 0.20,
        parkFactors: 0.10,
        recentForm: 0.15,
        weather: 0.10,
    },
    nfl: {
        offensiveYards: 0.20,
        defensiveYards: 0.20,
        turnovers: 0.15,
        redZoneEfficiency: 0.15,
        homeAdvantage: 0.15,
        injuries: 0.15,
    },
    tennis: {
        surfacePerformance: 0.25,
        headToHead: 0.20,
        recentForm: 0.20,
        fatigueLevel: 0.15,
        breakPointsConversion: 0.10,
        mentalStrength: 0.10,
    }
};

// AI Analysis Messages
const AI_INSIGHTS = {
    highConfidence: [
        "üéØ El an√°lisis estad√≠stico muestra una clara ventaja",
        "üíé Patr√≥n hist√≥rico muy favorable detectado",
        "üî• Todos los indicadores apuntan en la misma direcci√≥n",
        "‚ö° Oportunidad de alto valor identificada",
    ],
    mediumConfidence: [
        "üìä Los datos sugieren una tendencia favorable",
        "üîç An√°lisis de forma reciente indica ventaja moderada",
        "üìà El historial de enfrentamientos es prometedor",
        "‚öñÔ∏è Balance de factores favorable pero con incertidumbre",
    ],
    lowConfidence: [
        "‚ö†Ô∏è Partido equilibrado con m√∫ltiples factores en juego",
        "üé≤ Los datos hist√≥ricos muestran alta variabilidad",
        "üîÑ Ambos equipos atraviesan momentos similares",
        "‚ùì Recomendamos precauci√≥n en este encuentro",
    ],
    liveOpportunity: [
        "üö® ¬°ALERTA! Oportunidad detectada en vivo",
        "‚ö° El momentum ha cambiado significativamente",
        "üéØ Las probabilidades actuales no reflejan el dominio real",
        "üí∞ Valor encontrado - la cuota est√° inflada",
    ]
};

// Risk assessment messages
const RISK_FACTORS = {
    low: [
        "Riesgo bajo: Alta consistencia en resultados similares",
        "Historial muy predecible en este tipo de enfrentamientos",
    ],
    medium: [
        "Riesgo moderado: Algunos factores de incertidumbre presentes",
        "Considerar gesti√≥n de bankroll conservadora",
    ],
    high: [
        "‚ö†Ô∏è Riesgo alto: Alta volatilidad esperada",
        "Partido con muchas variables impredecibles",
    ]
};

/**
 * Agente de An√°lisis de Forma (Recent Form)
 * Calcula un puntaje de 0 a 1 basado en los √∫ltimos resultados reales (W, D, L)
 */
function analyzeForm(recentGames) {
    if (!recentGames || recentGames.length === 0) return 0.5;

    // Pesos: Victoria=1, Empate=0.5, Derrota=0
    const points = recentGames.reduce((acc, game) => {
        if (game.result === 'W') return acc + 1;
        if (game.result === 'D') return acc + 0.5;
        return acc;
    }, 0);

    return points / recentGames.length;
}

/**
 * Agente de Alineaci√≥n e Impacto de Jugadores
 * Ajusta la probabilidad basada en lesiones o l√≠deres ausentes
 */
function analyzeLineup(roster, injuries, leaders) {
    let penalty = 0;

    if (injuries && injuries.length > 0) {
        // Penalizaci√≥n por cantidad de lesionados
        penalty += Math.min(injuries.length * 0.02, 0.1);

        // Penalizaci√≥n cr√≠tica por l√≠deres lesionados
        if (leaders && leaders.length > 0) {
            const injuredLeaders = leaders.filter(l =>
                injuries.some(inj => inj.athlete?.id === l.athlete?.id)
            );
            penalty += injuredLeaders.length * 0.05;
        }
    }

    return penalty;
}

/**
 * Agente H2H (Enfrentamientos Directos)
 * Analiza la dominancia hist√≥rica
 */
function analyzeH2H(h2h) {
    if (!h2h || !Array.isArray(h2h) || h2h.length === 0) return 0.5;

    const wins = h2h.filter(g => g.result === 'W').length;
    return wins / h2h.length;
}

/**
 * Calculate match prediction using REAL DATA agents (v3.0 - Multimodal)
 */
export function calculatePrediction(match, analysis, config = {}) {
    const sport = match.sport;
    const { homeForm, awayForm, h2h, rosters, leaders, injuries } = analysis || {};

    // --- AGENTE 1: FORMA RECIENTE (Peso Din√°mico) ---
    // v6.0 ML Upgrade: Use weights from config if provided, else default
    const wForm = config?.weights?.formWeight || 0.35;
    const wH2H = config?.weights?.h2hWeight || 0.15;

    // Calculate Base 50/50
    let homeProb = 0.5;

    const homeFormScore = analyzeForm(homeForm?.recentGames);
    const awayFormScore = analyzeForm(awayForm?.recentGames);

    // Integraci√≥n de Forma (Weighted)
    homeProb += (homeFormScore - awayFormScore) * wForm;

    // --- AGENTE 2: H2H (Peso Din√°mico) ---
    const h2hScore = analyzeH2H(h2h);
    homeProb += (h2hScore - 0.5) * wH2H;

    // --- AGENTE 3: ALINEACI√ìN (Penalizaci√≥n) ---
    const homeInjuryPenalty = analyzeLineup(rosters?.home, analysis?.homeInjuries, leaders);
    const awayInjuryPenalty = analyzeLineup(rosters?.away, analysis?.awayInjuries, leaders);

    // --- AGENTE 4: FACTOR CAMPO (Base 4% para f√∫tbol - Realista) ---
    const homeAdvantage = (sport === 'football' || sport === 'soccer') ? 0.04 : 0.03;

    // --- AGENTE 5: FACTOR CLIM√ÅTICO (V4.0 Real) ---
    let weatherImpact = 0;
    if (analysis?.weather?.impact) {
        const wImp = analysis.weather.impact;
        // Si hay lluvia fuerte (>2mm), reduce la ventaja t√©cnica del favorito
        if (wImp.playStyle === 'Physical/Direct' && (homeFormScore > 0.6 || awayFormScore > 0.6)) {
            weatherImpact = -0.02; // El clima iguala el campo (impacto reducido)
        }
    }

    // --- AGENTE 6: FACTOR ARBITRAL (V4.0 Real) ---
    // No afecta directamente al 1X2 matem√°tico, pero s√≠ a la confianza

    // normalizaci√≥n V12.4: Decisiveness logic
    let finalHomeProb = homeProb * 100;

    // Inyecci√≥n de volatilidad inteligente (Favorece divergencia)
    let drift = (Math.random() * 16) - 8;
    finalHomeProb = Math.min(Math.max(finalHomeProb + drift, 12), 88);
    let finalAwayProb = 100 - finalHomeProb;

    // Reducimos base de empate (Era 25%, ahora 18% para evitar par√°lisis)
    let drawProb = 0;
    if (sport === 'football' || sport === 'soccer') {
        const diff = Math.abs(homeFormScore - awayFormScore);
        drawProb = 18 + (12 * (1 - diff)) + (Math.random() * 4);

        // Ajuste proporcional
        finalHomeProb *= (1 - (drawProb / 100));
        finalAwayProb *= (1 - (drawProb / 100));
    }

    // --- MOTOR MULTIDEPORTE V15 (Decoupled Engine) ---
    const swarmInsights = [];
    let mathHome = 0;
    let mathAway = 0;
    let mathDraw = 0;

    // 1. L√≥gica por Deporte
    if (sport === 'football' || sport === 'soccer') {
        // --- MODELO F√öTBOL (3-Way Poisson) ---
        let baseH = homeProb;
        let baseD = drawProb / 100 || 0.22;

        if (homeForm?.recentGames && awayForm?.recentGames) {
            const hStats = calcStats(homeForm.recentGames);
            const aStats = calcStats(awayForm.recentGames);
            if (hStats && aStats) {
                const { homeXG, awayXG } = calculateGoalExpectancy(hStats, aStats);
                const poi = calculatePoissonProbabilities(homeXG, awayXG);
                mathHome = (poi.homeWin * 0.65) + (baseH * 0.35);
                mathAway = (poi.awayWin * 0.65) + ((1 - baseH) * 0.35);
                mathDraw = (poi.draw * 0.65) + (baseD * 0.35);
                swarmInsights.push(`üìê Poisson xG: ${homeXG.toFixed(1)} - ${awayXG.toFixed(1)}`);
            }
        } else {
            mathHome = baseH; mathAway = 1 - baseH; mathDraw = baseD;
        }
    } else if (sport === 'basketball' || sport === 'nba') {
        // --- MODELO BALONCESTO (2-Way Point Spread) ---
        const hPoints = analyzeVolume(homeForm?.recentGames); // Puntos promedio
        const aPoints = analyzeVolume(awayForm?.recentGames);

        // El Basket es muy sensible a la forma actual (80% forma)
        mathHome = (homeFormScore * 0.8) + (h2hScore * 0.2);
        mathAway = 1 - mathHome;
        mathDraw = 0; // IMPOSIBLE EN BASKET

        if (hPoints > aPoints) swarmInsights.push("üèÄ Ventaja de volumen anotador detectada.");
    } else if (sport === 'baseball' || sport === 'mlb') {
        // --- MODELO B√âISBOL (Moneyline / Pitcher focus) ---
        // Aqu√≠ el rosters.home?.pitcher ser√≠a clave (Agente L√≠deres)
        mathHome = (h2hScore * 0.5) + (homeFormScore * 0.5);
        mathAway = 1 - mathHome;
        mathDraw = 0;
        swarmInsights.push("‚öæ An√°lisis de Bullpen y Moneyline completado.");
    } else if (sport === 'tennis') {
        // --- MODELO TENIS (Sets focus) ---
        mathHome = (homeFormScore * 0.7) + (h2hScore * 0.3);
        mathAway = 1 - mathHome;
        mathDraw = 0;
        swarmInsights.push("üéæ Duelo de sets analizado.");
    } else {
        // Default (NFL u otros)
        mathHome = homeProb;
        mathAway = 1 - homeProb;
        mathDraw = 0;
    }

    // Normalizaci√≥n final
    const total = (mathHome + mathAway + mathDraw) || 1;
    let trueHome = (mathHome / total) * 100;
    let trueAway = (mathAway / total) * 100;
    let trueDraw = (mathDraw / total) * 100;

    // Determinamos ganador real basado en los datos procesados
    let winner = 'draw';
    if (trueHome > trueAway && trueHome > trueDraw) winner = 'home';
    else if (trueAway > trueHome && trueAway > trueDraw) winner = 'away';
    else if (trueDraw > trueHome && trueDraw > trueAway) winner = 'draw';

    // Asegurar que en deportes sin empate el ganador sea s√≠ o s√≠ H o A
    if (mathDraw === 0 && winner === 'draw') {
        winner = trueHome >= trueAway ? 'home' : 'away';
    }

    // Insights de Veracidad
    if (h2hScore > 0.8) swarmInsights.push("üß¨ Dominancia H2H hist√≥rica.");
    if (homeFormScore > 0.85) swarmInsights.push("üî• Racha imparable local.");

    const maxP = Math.max(trueHome, trueAway, trueDraw);

    return {
        homeWinProb: Math.round(trueHome),
        awayWinProb: Math.round(trueAway),
        drawProb: Math.round(trueDraw),
        winner,
        confidence: getConfidenceLevel(maxP),
        swarmInsights
    };
}

// Helpers internos para V15
function calcStats(games) {
    let s = 0, c = 0, count = 0;
    if (!games) return null;
    games.forEach(g => {
        if (!g.score) return;
        const p = g.score.split('-');
        const sG = parseInt(p[0]); const cG = parseInt(p[1]);
        if (!isNaN(sG)) { s += sG; c += cG; count++; }
    });
    return count > 0 ? { scoredAvg: s / count, concededAvg: c / count } : null;
}

function analyzeVolume(games) {
    if (!games || games.length === 0) return 100; // NBA avg
    let total = 0;
    games.forEach(g => {
        if (!g.score) return;
        const p = g.score.split('-');
        total += (parseInt(p[0]) || 0);
    });
    return total / games.length;
}

/**
 * Get confidence level based on REAL probability (V14 Strict)
 */
function getConfidenceLevel(probability) {
    if (probability >= 65) return 'diamond';
    if (probability >= 52) return 'gold';
    return 'silver';
}

/**
 * Generate AI insight message
 */
export function generateAIInsight(confidence, isLive = false) {
    if (isLive) {
        return AI_INSIGHTS.liveOpportunity[Math.floor(Math.random() * AI_INSIGHTS.liveOpportunity.length)];
    }

    const insights = confidence === 'diamond'
        ? AI_INSIGHTS.highConfidence
        : confidence === 'gold'
            ? AI_INSIGHTS.mediumConfidence
            : AI_INSIGHTS.lowConfidence;

    return insights[Math.floor(Math.random() * insights.length)];
}

/**
 * Generate detailed analysis for a match
 */
export function generateDetailedAnalysis(match) {
    const sport = match.sport;
    const home = match.home.name;
    const away = match.away.name;

    const analyses = {
        football: [
            {
                title: "An√°lisis de xG (Goles Esperados)",
                content: `${home} promedia ${(1.5 + Math.random()).toFixed(2)} xG en casa mientras ${away} genera solo ${(1.2 + Math.random() * 0.5).toFixed(2)} xG como visitante. Esta diferencia de ${(0.3 + Math.random() * 0.5).toFixed(2)} xG es estad√≠sticamente significativa.`,
                icon: "üìä"
            },
            {
                title: "Factor Local",
                content: `${home} ha ganado el ${65 + Math.floor(Math.random() * 20)}% de sus partidos en casa esta temporada, muy por encima de la media de la liga (52%).`,
                icon: "üèüÔ∏è"
            },
            {
                title: "Forma Reciente",
                content: `√öltimos 5 partidos: ${home} (${3 + Math.floor(Math.random() * 2)}V-${Math.floor(Math.random() * 2)}E-${Math.floor(Math.random() * 2)}D) vs ${away} (${2 + Math.floor(Math.random() * 2)}V-${Math.floor(Math.random() * 3)}E-${Math.floor(Math.random() * 2)}D).`,
                icon: "üìà"
            },
        ],
        basketball: [
            {
                title: "Ritmo y Eficiencia",
                content: `${home} juega al ${100 + Math.floor(Math.random() * 10)} de pace con ${110 + Math.floor(Math.random() * 10)} de rating ofensivo. ${away} tiene solo ${105 + Math.floor(Math.random() * 8)} de rating defensivo.`,
                icon: "‚ö°"
            },
            {
                title: "Factor Descanso",
                content: `${away} viene de jugar hace ${1 + Math.floor(Math.random() * 2)} d√≠a(s), mientras ${home} tuvo ${2 + Math.floor(Math.random() * 2)} d√≠as de descanso.`,
                icon: "üí§"
            },
        ],
        tennis: [
            {
                title: "Rendimiento en Superficie",
                content: `En esta superficie, el jugador local tiene un ${60 + Math.floor(Math.random() * 25)}% de victorias en los √∫ltimos 2 a√±os.`,
                icon: "üéæ"
            },
            {
                title: "Puntos de Break",
                content: `El an√°lisis de break points muestra una conversi√≥n del ${35 + Math.floor(Math.random() * 20)}% del favorito vs ${25 + Math.floor(Math.random() * 15)}% del rival.`,
                icon: "üí™"
            },
        ]
    };

    return analyses[sport] || analyses.football;
}

/**
 * Calculate suggested stake based on confidence
 */
export function calculateSuggestedStake(confidence, bankrollPercentage = 100) {
    const stakePercentages = {
        diamond: { min: 3, max: 5, units: '3-5' },
        gold: { min: 2, max: 3, units: '2-3' },
        silver: { min: 1, max: 2, units: '1-2' },
    };

    const stake = stakePercentages[confidence] || stakePercentages.silver;
    const suggestedAmount = (bankrollPercentage * stake.min / 100).toFixed(2);

    return {
        percentage: stake.units,
        amount: suggestedAmount,
        risk: confidence === 'diamond' ? 'low' : confidence === 'gold' ? 'medium' : 'high',
        units: stake.min,
    };
}

/**
 * Detect Value Bet (Real Market Analysis)
 * Compara la probabilidad calculada por la IA contra la probabilidad impl√≠cita de las cuotas.
 */
export function detectValueBet(aiProbability, marketOdds) {
    if (!marketOdds || marketOdds <= 1) return { isValue: false };

    const impliedProb = 100 / parseFloat(marketOdds);
    const edge = aiProbability - impliedProb;

    return {
        isValue: edge > 3.5, // Edge m√≠nimo del 3.5% para ser considerado valor
        edge: edge.toFixed(1),
        impliedProbability: impliedProb.toFixed(1),
        actualProbability: aiProbability.toFixed(1),
        recommendation: edge > 10 ? 'FUERTE' : edge > 5 ? 'MODERADO' : 'VALOR AJUSTADO'
    };
}

/**
 * Generate live betting opportunity alert
 */
export function generateLiveAlert(match, momentum) {
    const alerts = [
        {
            type: 'momentum_shift',
            title: '‚ö° Cambio de Momentum',
            message: `${match.home.name} est√° dominando con ${momentum}% de posesi√≥n. Las cuotas a√∫n no lo reflejan.`,
            urgency: 'high'
        },
        {
            type: 'goal_imminent',
            title: 'üéØ Gol Inminente',
            message: `Presi√≥n alta detectada. Probabilidad de gol en los pr√≥ximos 10 minutos: ${70 + Math.floor(Math.random() * 15)}%`,
            urgency: 'critical'
        },
        {
            type: 'value_detected',
            title: 'üí∞ Valor Detectado',
            message: `La cuota actual de ${(2 + Math.random() * 2).toFixed(2)} est√° ${15 + Math.floor(Math.random() * 10)}% por encima del valor real.`,
            urgency: 'medium'
        }
    ];

    return alerts[Math.floor(Math.random() * alerts.length)];
}
